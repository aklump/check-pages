#!/usr/bin/env php
<?php
/**
 * @file
 * Entry file for Check Pages CLI.
 */

use AKlump\CheckPages\CheckPages;
use AKlump\CheckPages\Command\RunCommand;
use AKlump\CheckPages\Files\LocalFilesProvider;
use AKlump\CheckPages\Handlers\AddHandlerAutoloads;
use AKlump\CheckPages\Plugin\HandlersManager;
use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\DependencyInjection\Loader\YamlFileLoader;
use Symfony\Component\DependencyInjection\ContainerBuilder;

foreach ([
           __DIR__ . '/../../autoload.php',
           __DIR__ . '/../vendor/autoload.php',
           __DIR__ . '/vendor/autoload.php',
         ] as $file) {
  if (file_exists($file)) {
    /** @var \Composer\Autoload\ClassLoader $class_loader */
    $class_loader = require_once $file;
    break;
  }
}
if (!$class_loader) {
  throw new \RuntimeException('Missing autoload.php');
}

global $container;
$container = new ContainerBuilder();

$root_files = new LocalFilesProvider(__DIR__);

// This will load the services into the $container.
$loader = new YamlFileLoader($container, $root_files);
$loader->load('services.DO_NOT_EDIT.yml');

$application = new Application();
$application->setName('Check Pages by In the Loft Studios');

$composer_json = $root_files->tryResolveFile('composer.json')[0];
$version = json_decode(file_get_contents($composer_json))->version ?? '';
$application->setVersion($version);

$path_to_handlers = realpath($root_files->tryResolveDir('includes/' . CheckPages::DIR_HANDLERS)[0]);
$handlers_manger = new HandlersManager($path_to_handlers);
$container->set('handlers_manager', $handlers_manger);

// TODO Can this be optimized and cached in an autoload.php?
(new AddHandlerAutoloads($handlers_manger))($class_loader);

$application->add(new RunCommand($root_files));

// Expose commands to plugins via events.
foreach ($application->all() as $command) {
  if ($command->getName() === 'run') {
    $command->addOption('debug', NULL, InputOption::VALUE_OPTIONAL);
  }
}

$application->run();
