#!/usr/bin/env php
<?php
/**
 * @file
 * Entry file for Check Pages CLI.
 */

if (file_exists(__DIR__ . '/../../autoload.php')) {
  require __DIR__ . '/../../autoload.php';
}
else {
  require __DIR__ . '/vendor/autoload.php';
}

use AKlump\CheckPages\CheckPages;
use AKlump\CheckPages\Command\RunCommand;
use AKlump\CheckPages\Files\LocalFilesProvider;
use AKlump\CheckPages\Plugin\HandlersManager;
use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\DependencyInjection\Loader\YamlFileLoader;
use Symfony\Component\DependencyInjection\ContainerBuilder;

global $container;
$container = new ContainerBuilder();

$root_files = new LocalFilesProvider(__DIR__);

// This will load the services into the $container.
$loader = new YamlFileLoader($container, $root_files);
$loader->load('services.DO_NOT_EDIT.yml');

$application = new Application();
$application->setName('Check Pages by In the Loft Studios');

$composer_json = $root_files->tryResolveFile('composer.json')[0];
$version = json_decode(file_get_contents($composer_json))->version ?? '';
$application->setVersion($version);

$path_to_handlers = realpath($root_files->tryResolveDir('includes/' . CheckPages::DIR_HANDLERS)[0]);
$container->set('handlers_manager', new HandlersManager($path_to_handlers));

$application->add(new RunCommand($root_files));

// Expose commands to plugins via events.
foreach ($application->all() as $command) {
  if ($command->getName() === 'run') {
    $command->addOption('debug', NULL, InputOption::VALUE_OPTIONAL);
  }
}

$application->run();
