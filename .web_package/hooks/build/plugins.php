<?php

/**
 * @file
 * Compile the plugins into the main app.
 */

use Symfony\Component\Yaml\Yaml;

define('ROOT', $argv[7]);

require_once ROOT . '/vendor/autoload.php';

$compiler = new PluginCompiler(
  ROOT . '/plugins/find',
  ROOT . '/schema.visit.json',
  ROOT . '/example'
);
$compiler->compile();

final class PluginCompiler {

  /**
   * PluginCompiler constructor.
   *
   * @param string $plugins_dir
   * @param string $master_schema
   * @param string $examples_path
   */
  public function __construct(string $plugins_dir, string $master_schema, string $examples_path) {
    $this->pluginsDir = $plugins_dir;
    $this->schemaPath = $master_schema;
    $this->examplesPath = $examples_path;
  }

  /**
   * Compile all plugins into the app.
   */
  public function compile() {
    $directory_listing = scandir($this->pluginsDir);
    $plugins = [];
    foreach ($directory_listing as $basename) {
      $filepath = $this->pluginsDir . "/$basename";
      if ($basename !== '.' && $basename !== '..' && is_dir($filepath)) {
        $id = pathinfo($filepath, PATHINFO_FILENAME);
        $plugins[] = ['id' => $id, 'path' => $filepath];
        $this->compilePlugin($id, $filepath);
      }
    }
    $this->createTestRunnerPhpFile($plugins);
  }

  private function createTestRunnerPhpFile($plugins) {
    $runner_code = [
      '<?php',
      "/** AUTOGENERATED DO NOT EDIT */",
      "add_directory('{$this->examplesPath}/tests/plugins');",
      "load_config('config/local');",
    ];

    foreach ($plugins as $plugin) {
      $runner_code[] = "run_suite('{$plugin['id']}');";
    }
    $runner_file_path = $this->examplesPath . '/tests/runner_plugins.php';
    $result = file_put_contents($runner_file_path, implode(PHP_EOL, $runner_code));
    if (!$result) {
      throw new \RuntimeException(sprintf('Cannot create runner file: %s', $runner_file_path));
    }
  }

  /**
   * Compile the plugin schema file.
   *
   * @param string $id
   *   The plugin ID.
   * @param string $path_to_plugin
   *   The filepath to the plugin definition directory.
   */
  private function compilePlugin(string $id, string $path_to_plugin) {
    $this->compilePluginSchema($id, $path_to_plugin);
    $this->handleTests($id, $path_to_plugin);
  }

  /**
   * Compile the plugin schema file.
   *
   * @param string $id
   *   The plugin ID.
   * @param string $path_to_plugin
   *   The filepath to the plugin definition directory.
   */
  private function handleTests(string $id, string $path_to_plugin) {

    if (!is_dir($this->examplesPath . "/tests/plugins/")) {
      mkdir($this->examplesPath . "/tests/plugins/", 0755, TRUE);
    }

    // Locate the file with the filename of 'test_subject'.
    $subject = array_first(array_filter(scandir($path_to_plugin), function ($path) {
      return pathinfo($path, PATHINFO_FILENAME) === 'test_subject';
    }));
    if (empty($subject)) {
      throw new \RuntimeException(sprintf('Missing filename "test_subject.*" for plugin %s.', $id));
    }

    $extension = pathinfo($subject, PATHINFO_EXTENSION);
    $suite_relative_path_final = "plugins/$id.$extension";
    copy("$path_to_plugin/$subject", $this->examplesPath . "/web/${suite_relative_path_final}");

    // The test suite.
    if (!is_dir($this->examplesPath . "/web/plugins/")) {
      mkdir($this->examplesPath . "/web/plugins/", 0755, TRUE);
    }
    $plugin_suite = Yaml::parseFile($path_to_plugin . '/suite.yml');
    $plugin_suite = array_map(function (array $test) use ($subject, $suite_relative_path_final) {
      if (array_key_exists('visit', $test)) {
        $test['visit'] = str_replace($subject, $suite_relative_path_final, $test['visit']);
      }
      if (array_key_exists('url', $test)) {
        $test['url'] = str_replace($subject, $suite_relative_path_final, $test['url']);
      }

      return $test;
    }, $plugin_suite);
    file_put_contents($this->examplesPath . "/tests/plugins/{$id}.yml", Yaml::dump($plugin_suite, 6));
  }

  /**
   * Compile the plugin schema file.
   *
   * @param string $id
   *   The plugin ID.
   * @param string $path_to_plugin
   *   The filepath to the plugin definition directory.
   */
  private function compilePluginSchema(string $id, string $path_to_plugin) {
    if (empty($this->master)) {
      $this->master = $this->loadJson(str_replace('.json', '.template.json', $this->schemaPath));
    }

    if (isset($this->master['definitions'][$id])) {
      throw new \RuntimeException(sprintf('Plugin ID conflict; %s.definitions.%s already exists', basename($this->schemaPath), $id));
    }

    $schema_path = $path_to_plugin . '/schema.json';
    $this->master['definitions'][$id] = $this->loadJson($schema_path);
    $this->master['items']['properties']['find']['oneOf'][1]['items']['oneOf'][] = [
      '$ref' => "#/definitions/{$id}",
    ];
    $this->saveJson($this->schemaPath, $this->master);
  }

  private function loadJson(string $filepath) {
    $data = json_decode(file_get_contents($filepath), TRUE);
    if (!$data) {
      throw new \RuntimeException(sprintf('Invalid JSON in %s', $filepath));
    }

    return $data;
  }

  private function saveJson($filepath, $data) {
    $result = file_put_contents($filepath, json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
    if (!$result) {
      throw new \RuntimeException(sprintf('Could not save %s', $filepath));
    }

    return $this;
  }

}
